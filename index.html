<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyShop</title>

<style>
/* RESET & BASE */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui, sans-serif;
  background:#f1f3f6;
  color:#333;
}

/* HEADER */
.header{
  background:#2874f0;
  color:white;
  padding:12px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:sticky;
  top:0;
  z-index:1000;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.logo{
  font-size:20px;
  font-weight:bold;
}

.search{
  flex:1;
  margin:0 12px;
}

.search input{
  width:100%;
  padding:8px 12px;
  border-radius:20px;
  border:none;
  outline:none;
  font-size:14px;
}

.nav-links a{
  color:white;
  text-decoration:none;
  margin-left:12px;
  font-size:16px;
}

/* OFFER */
.offer-banner{
  background:linear-gradient(90deg,#ff416c,#ff4b2b);
  color:white;
  text-align:center;
  padding:12px;
  font-weight:600;
  white-space:nowrap;
  overflow:hidden;
}

/* CATEGORY */
.category{
  display:flex;
  overflow-x:auto;
  background:white;
  padding:10px 8px;
  gap:10px;
  border-bottom:1px solid #eee;
}
.category::-webkit-scrollbar{ display:none; }

.category div{
  min-width:90px;
  background:#f0f0f0;
  padding:6px 12px;
  border-radius:20px;
  text-align:center;
  font-size:13px;
  cursor:pointer;
  transition:0.3s;
  white-space:nowrap;
}
.category div.active{
  background:#2874f0;
  color:white;
}

/* BANNER */
.banner{
  position:relative;
  width:100%;
  overflow:hidden;
  background:white;
  margin-top:8px;
  border-radius:10px;
}
.banner-track{
  display:flex;
  transition:transform 0.6s ease-in-out;
}
.banner-slide{
  min-width:100%;
}
.banner-slide img{
  width:100%;
  height:35vw;
  max-height:180px;
  object-fit:cover;
  border-radius:10px;
}

/* PRODUCTS - horizontal rows */
.products{
  display:flex;
  flex-direction:column;
  gap:15px;
  margin-bottom:90px;
}

.product-row{
  display:flex;
  overflow-x:auto;
  gap:10px;
  padding:10px 5px;
  scroll-snap-type: x mandatory;
}
.product-row::-webkit-scrollbar{
  height:6px;
}
.product-row::-webkit-scrollbar-thumb{
  background:rgba(0,0,0,0.2);
  border-radius:3px;
}
.product-row .card{
  min-width:150px;
  flex:0 0 auto;
  scroll-snap-align: start;
  background:white;
  padding:12px 8px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  text-align:center;
  transition:0.3s;
  cursor:pointer;
}
.product-row .card:hover{
  box-shadow:0 4px 12px rgba(0,0,0,0.12);
  transform:translateY(-2px);
}

.card img{
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:8px;
}

.card h3{
  font-size:14px;
  margin:8px 0 4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.price{
  color:#388e3c;
  font-weight:600;
  font-size:14px;
}

.stock{
  font-size:12px;
  margin-top:4px;
}

button{
  background:#fb641b;
  border:none;
  padding:8px 0;
  width:100%;
  color:white;
  border-radius:20px;
  cursor:pointer;
  font-size:14px;
  margin-top:6px;
  transition:0.3s;
}
button:hover:not(:disabled){
  background:#e55a1f;
}
button:disabled{
  background:gray;
  cursor:not-allowed;
}

/* FOOTER - Blinkit style */
.footer{
  position:fixed;
  bottom:0;
  width:100%;
  background:white;
  display:flex;
  justify-content:space-around;
  align-items:center;
  padding:6px 0;
  border-top:1px solid #ddd;
  box-shadow:0 -2px 5px rgba(0,0,0,0.05);
  font-size:24px;
  z-index:999;
}

.footer a{
  text-decoration:none;
  color:#666;
  display:flex;
  flex-direction:column;
  align-items:center;
  font-size:18px;
  transition:0.3s;
}

.footer a span:first-child{
  font-size:22px;
}

.footer a span:last-child{
  font-size:12px;
  margin-top:2px;
}

.footer a.active, .footer a:hover{
  color:#2874f0;
}

/* LOADING */
.loading{
  text-align:center;
  padding:20px;
  font-weight:bold;
  color:#666;
}

/* RESPONSIVE */
@media (min-width:600px){
  .product-row .card{min-width:180px;}
}
@media (min-width:900px){
  .product-row .card{min-width:200px;}
}
</style>
</head>

<body>

<div class="header">
  <div class="logo">MyShop</div>
  <div class="search">
    <input type="text" id="searchInput" placeholder="Search products...">
  </div>
  <div class="nav-links">
    <a href="cart.html">Cart üõí</a>
    <a href="logout.html">Account üë§</a>
  </div>
</div>

<!-- OFFER BANNER -->
<div class="offer-banner" id="offer-banner">
  Loading offer...
</div>

<div class="category">
  <div data-cat="All" class="active">All</div>
  <div data-cat="Mobile">Mobile</div>
  <div data-cat="Fashion">Fashion</div>
  <div data-cat="Electronics">Electronics</div>
  <div data-cat="Grocery">Grocery</div>
  <div data-cat="Appliances">Appliances</div>
  <div data-cat="Books">Books</div>
</div>

<div class="banner">
  <div class="banner-track" id="banner-container">
    <div class="loading">Loading banners...</div>
  </div>
</div>

<div class="products" id="products">
  <div class="loading">Checking login...</div>
</div>

<!-- FOOTER -->
<div class="footer">
  <a href="#" class="active"><span>üè†</span><span>Home</span></a>
  <a href="/sell/c.html"><span>üõí</span><span>Cart</span></a>
  <a href="#"><span>üéÅ</span><span>Offers</span></a>
  <a href="/sell/my order.html"><span>üì¶</span><span>Order</span></a>
</div>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"

const supabase = createClient(
  "https://ooiumaohawwtqtiodqcv.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vaXVtYW9oYXd3dHF0aW9kcWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNDQ1MjMsImV4cCI6MjA4NjcyMDUyM30.S_1J8CFMa1KJUYfk1VYeUcFRqUo23NEGzNlxr5fQsvA"
)

/* LOGIN CHECK */
const { data: { session } } = await supabase.auth.getSession()

let selectedCategory = "All"
let currentIndex = 0
let totalSlides = 0

loadOffer()
loadProducts()
loadBanners()

/* CATEGORY FILTER */
document.querySelectorAll(".category div").forEach(cat => {
  cat.addEventListener("click", () => {
    document.querySelectorAll(".category div").forEach(c => c.classList.remove("active"))
    cat.classList.add("active")
    selectedCategory = cat.getAttribute("data-cat")
    loadProducts()
  })
})

/* SEARCH */
document.getElementById("searchInput").addEventListener("input", loadProducts)

/* CART CLICK */
document.querySelectorAll('.nav-links a[href="/sell/c.html"]').forEach(link => {
  link.addEventListener('click', (e) => {
    if(!session){
      e.preventDefault()
      alert("Please login first to access the Cart üõí")
      window.location.href = "login.html"
    }
  })
})

/* LOAD OFFER */
async function loadOffer(){
  const banner = document.getElementById("offer-banner")
  const { data, error } = await supabase.from("offers").select("*").eq("active", true).limit(1).single()
  if(error || !data){
    banner.innerHTML = ""
    return
  }
  banner.innerHTML = data.title
}

/* LOAD PRODUCTS */
async function loadProducts(){
  const container = document.getElementById("products")
  container.innerHTML = "<div class='loading'>Loading...</div>"

  let query = supabase.from("products").select("*")
  if(selectedCategory !== "All"){
    query = query.eq("category", selectedCategory)
  }

  const { data, error } = await query.order("id", { ascending: false })
  if(error){
    container.innerHTML = "<div class='loading'>Error loading</div>"
    return
  }

  let searchValue = document.getElementById("searchInput").value.toLowerCase()
  let filtered = data.filter(p => p.name.toLowerCase().includes(searchValue))
  if(filtered.length === 0){
    container.innerHTML = "<div class='loading'>No products found</div>"
    return
  }

  container.innerHTML = ""

  const chunkSize = 5
  for(let i=0; i<filtered.length; i+=chunkSize){
    let chunk = filtered.slice(i, i+chunkSize)
    let row = document.createElement("div")
    row.classList.add("product-row")
    
    chunk.forEach(product => {

      // ‚úÖ FIRST IMAGE FROM ARRAY
      const firstImage = product.images && product.images.length > 0 
        ? product.images[0] 
        : "https://via.placeholder.com/150"

      let stockText = ""
      let disabled = ""
      if(product.quantity <= 0){
        stockText = `<span style="color:red;font-weight:bold;">Out of Stock</span>`
        disabled = "disabled"
      } else if(product.quantity <=3){
        stockText = `<span style="color:orange;">Only ${product.quantity} left!</span>`
      } else {
        stockText = `Stock: ${product.quantity}`
      }

      row.innerHTML += `
        <div class="card" onclick="window.location.href='product.html?id=${product.id}'">
          <img src="${firstImage}">
          <h3>${product.name}</h3>
          <p class="price">‚Çπ${product.price}</p>
          <div class="stock">${stockText}</div>
          <button ${disabled} onclick="event.stopPropagation(); addToCart(${product.id})">
            Add to Cart
          </button>
        </div>
      `
    })
    container.appendChild(row)
  }
}

/* ADD TO CART */
window.addToCart = async (id) => {
  if(!session){ 
    alert("Please login first to add products to the Cart üõí")
    window.location.href = "login.html"
    return
  }

  const { data } = await supabase.from("products").select("*").eq("id", id).single()

  // ‚úÖ FIRST IMAGE SAVE IN CART
  const firstImage = data.images && data.images.length > 0 
    ? data.images[0] 
    : "https://via.placeholder.com/150"

  let cart = JSON.parse(localStorage.getItem("cart")) || []
  let existing = cart.find(p => p.id === id)

  if(existing){
    existing.quantity += 1
  }else{
    cart.push({
      id: data.id,
      name: data.name,
      price: data.price,
      image: firstImage,
      quantity: 1
    })
  }

  localStorage.setItem("cart", JSON.stringify(cart))
  alert("Added to Cart üõí")
}

/* LOAD BANNERS */
async function loadBanners(){
  const bannerContainer = document.getElementById("banner-container")
  const { data } = await supabase.from("banners").select("*").eq("active", true)

  if(!data || data.length === 0){
    bannerContainer.innerHTML = ""
    return
  }

  bannerContainer.innerHTML = ""
  data.forEach(banner => {
    bannerContainer.innerHTML += `
      <div class="banner-slide">
        <img src="${banner.image}">
      </div>
    `
  })

  totalSlides = data.length
  startAutoSlide()
}

function startAutoSlide(){
  const track = document.getElementById("banner-container")
  setInterval(() => {
    currentIndex++
    if(currentIndex >= totalSlides) currentIndex = 0
    track.style.transform = `translateX(-${currentIndex * 100}%)`
  }, 3000)
}
</script>
</body>
</html>
