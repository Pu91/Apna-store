<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Product Details</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- HEADER -->
<header class="bg-blue-600 text-white p-4 shadow-md">
  <div class="max-w-6xl mx-auto flex justify-between items-center">
    <a href="index.html" class="text-xl font-bold">MyShop</a>
    <nav>
      <a href="index.html" class="mr-4 hover:underline">Home</a>
      <a href="cart.html" class="hover:underline">Cart üõí</a>
    </nav>
  </div>
</header>

<!-- PRODUCT SECTION -->
<main class="max-w-6xl mx-auto mt-8 p-4 bg-white rounded-xl shadow">

  <div class="grid md:grid-cols-2 gap-8" id="product-container">
    Loading...
  </div>

  <!-- REVIEWS -->
  <div class="mt-12">
    <h3 class="text-xl font-bold mb-4">Ratings & Reviews ‚≠ê</h3>
    <div id="reviews" class="space-y-3"></div>
  </div>

  <!-- RELATED PRODUCTS -->
  <div class="mt-12">
    <h3 class="text-xl font-bold mb-4">Related Products</h3>
    <div id="related-products" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
  </div>

</main>

<!-- FOOTER -->
<footer class="bg-gray-800 text-gray-300 mt-12 p-6 text-center text-sm">
  &copy; 2026 MyShop | All rights reserved
</footer>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"

const supabase = createClient(
  "https://ooiumaohawwtqtiodqcv.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vaXVtYW9oYXd3dHF0aW9kcWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNDQ1MjMsImV4cCI6MjA4NjcyMDUyM30.S_1J8CFMa1KJUYfk1VYeUcFRqUo23NEGzNlxr5fQsvA"
)

const urlParams = new URLSearchParams(window.location.search)
const productId = urlParams.get("id")
const container = document.getElementById("product-container")

if(productId){
  loadProduct(productId)
}

/* ================= LOAD PRODUCT ================= */

async function loadProduct(id){
  const { data, error } = await supabase
    .from("products")
    .select("*")
    .eq("id", id)
    .single()

  if(error || !data){
    container.innerHTML = "Product not found."
    return
  }

  const images = data.images?.length
    ? data.images
    : ["https://via.placeholder.com/400"]

  container.innerHTML = `
    <div>
      <img id="mainImage" src="${images[0]}" 
           class="w-full h-96 object-contain rounded-lg border mb-4">

      <div class="flex gap-2 flex-wrap">
        ${images.map(img => `
          <img src="${img}" 
               onclick="changeImage('${img}')"
               class="w-20 h-20 object-cover border cursor-pointer rounded hover:scale-105 transition">
        `).join("")}
      </div>
    </div>

    <div>
      <h2 class="text-2xl font-bold mb-2">${data.name}</h2>
      <div id="ratingBox" class="mb-2 text-yellow-500 font-semibold">
        Loading rating...
      </div>
      <div class="text-green-600 text-xl font-semibold mb-2">‚Çπ${data.price}</div>
      <p class="text-gray-700 mb-4">${data.description || "No description available."}</p>

      <button onclick="addToCart(${data.id})"
        class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600">
        Add to Cart
      </button>
      
      
      <button onclick="buyNow(${data.id})"
  class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 ml-2">
  Buy Now
</button>


      <!-- DELIVERY INFO -->
      <div class="mt-4 text-sm text-gray-600 space-y-1">
        <p>üöö Free Delivery (6‚Äì7 Days)</p>
        <p>üîÑ 7 Days Easy Return</p>
        <p>üíµ Cash on Delivery Available</p>
      </div>
    </div>
  `

  renderReviewForm(id)
  loadReviews(id)
  loadRelated(data.category)
}

/* ================= IMAGE CHANGE ================= */

window.changeImage = (src) => {
  document.getElementById("mainImage").src = src
}

/* ================= ADD TO CART ================= */

window.addToCart = async (id) => {
  let cart = JSON.parse(localStorage.getItem("cart")) || []

  const { data } = await supabase
    .from("products")
    .select("*")
    .eq("id", id)
    .single()

  const firstImage = data.images?.[0] || "https://via.placeholder.com/150"

  let existing = cart.find(p => p.id === id)

  if(existing){
    existing.quantity += 1
  } else {
    cart.push({
      id: data.id,
      name: data.name,
      price: data.price,
      image: firstImage,
      quantity:1
    })
  }

  localStorage.setItem("cart", JSON.stringify(cart))
  alert("Added to Cart üõí")
  window.location.href = "index.html"
}

/* ================= BUY NOW ================= */

window.buyNow = async (id) => {
  let cart = []

  const { data } = await supabase
    .from("products")
    .select("*")
    .eq("id", id)
    .single()

  const firstImage = data.images?.[0] || "https://via.placeholder.com/150"

  cart.push({
    id: data.id,
    name: data.name,
    price: data.price,
    image: firstImage,
    quantity:1
  })

  localStorage.setItem("cart", JSON.stringify(cart))
  window.location.href = "cart.html"
}


/* ================= REVIEW FORM ================= */

function renderReviewForm(productId){
  const reviewSection = document.getElementById("reviews")

  reviewSection.insertAdjacentHTML("beforebegin", `
    <div class="mb-6 bg-gray-100 p-4 rounded">
      <h4 class="font-bold mb-2">Write a Review</h4>
      <input id="userName" type="text" placeholder="Your Name"
        class="w-full p-2 mb-2 border rounded">
      
      <select id="ratingInput" class="w-full p-2 mb-2 border rounded">
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
        <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
        <option value="2">‚≠ê‚≠ê (2)</option>
        <option value="1">‚≠ê (1)</option>
      </select>

      <textarea id="commentInput" placeholder="Write your review..."
        class="w-full p-2 mb-2 border rounded"></textarea>

      <button onclick="submitReview(${productId})"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Submit Review
      </button>
    </div>
  `)
}

/* ================= SUBMIT REVIEW ================= */

window.submitReview = async (productId) => {
  const user_name = document.getElementById("userName").value
  const rating = parseInt(document.getElementById("ratingInput").value)
  const comment = document.getElementById("commentInput").value

  if(!user_name){
    alert("Please enter your name")
    return
  }

  await supabase.from("reviews").insert([{
    product_id: productId,
    user_name,
    rating,
    comment,
    is_approved: false
  }])

  alert("Review submitted. Waiting for admin approval ‚úÖ")
  document.getElementById("userName").value=""
  document.getElementById("commentInput").value=""
}

/* ================= LOAD APPROVED REVIEWS ================= */

async function loadReviews(productId){

  const { data } = await supabase
    .from("reviews")
    .select("*")
    .eq("product_id", productId)
    .eq("is_approved", true)
    .order("created_at", {ascending:false})

  const reviewBox = document.getElementById("reviews")
  const ratingBox = document.getElementById("ratingBox")

  if(!data || data.length === 0){
    ratingBox.innerHTML = "No ratings yet ‚≠ê"
    reviewBox.innerHTML = "No reviews yet."
    return
  }

  let total = 0
  data.forEach(r => total += r.rating)
  const avg = (total / data.length).toFixed(1)

  ratingBox.innerHTML = `‚≠ê ${avg} / 5 (${data.length} reviews)`

  reviewBox.innerHTML = data.map(r => `
    <div class="bg-gray-100 p-3 rounded">
      <div class="flex justify-between text-sm text-gray-600">
        <span><b>${r.user_name}</b></span>
        <span>${new Date(r.created_at).toLocaleDateString()}</span>
      </div>
      <div class="text-yellow-500">${"‚≠ê".repeat(r.rating)}</div>
      <p class="mt-1">${r.comment || ""}</p>
    </div>
  `).join("")
}

/* ================= RELATED PRODUCTS ================= */

async function loadRelated(category){
  const { data } = await supabase
    .from("products")
    .select("*")
    .eq("category", category)
    .limit(4)

  const container = document.getElementById("related-products")

  container.innerHTML = data.map(p => {
    const firstImage = p.images?.[0] || "https://via.placeholder.com/150"
    return `
      <a href="product.html?id=${p.id}" 
         class="bg-white border rounded-lg p-2 shadow hover:shadow-md">
         <img src="${firstImage}" class="h-32 w-full object-contain">
         <p class="text-sm font-semibold mt-2">${p.name}</p>
         <p class="text-green-600 font-bold">‚Çπ${p.price}</p>
      </a>
    `
  }).join("")
}
</script> 
</body>
</html>
